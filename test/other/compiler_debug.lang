import "std/memory"

type Array<T> {
	let capacity : u64 = 0;
	let length : u64 = 0;
	let data : T* = null_pointer();
}

function reserve<T>(this: Array<T>*, size: u64) : void {
	if(size <= .capacity)
		return;
	
	let ptr : T* = malloc(size);
	
	if(.length > 0) {
		for(let idx : u64 = 0; idx < .length; ++idx) {
			ptr[idx] = .data[idx];
		}
		free(.data);
	}
	
	.capacity = size;
	.data = ptr;
}

function push_back<T>(this: Array<T>*, value: T) : u64 {
	if(.capacity <= .length) 
		.reserve((.capacity + 1) * 2);
	
	.data[.length] = value;
	++.length;
	return .length;
}

function get<T>(this: Array<T>*, index: u64) : T {
	return .data[index];
}

function destructor<T>(this: Array<T>*) : void {
	free(.data);
	.length = 0;
	.capacity = 0;
}

function dump<T>(this: Array<T>*) : void {
	printf("----------------\n");
	for(let idx : u64 = 0; idx < .length; ++idx) {
		printf("%d = %d\n", idx, .data[idx]);
	}
}

function test() : Array<u64> {
	let arr : Array<u64>;
	
	const forty_two : u64 = 42; // Forced Cast, otherwise the we can't resolve the function, yet.
	const leet : u64 = 1337;
	arr.push_back(forty_two);
	arr.push_back(leet);
	arr.dump();
	arr.push_back(forty_two);
	arr.push_back(leet);
	arr.dump();
	
	return arr;
}

function main() {
	let t = test();
	t.dump();
	return t.length;
}
